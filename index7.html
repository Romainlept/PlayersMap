<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Modular Industry Globe with Manual Refresh</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial; }
    #globeViz { width: 100vw; height: 100vh; }
    #infoPanel {
      position: absolute;
      right: 20px;
      top: 60px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      width: 250px;
      display: none;
    }
    #infoPanel h3 { margin-top: 0; }
    #infoPanel ul { padding-left: 20px; }
    #refreshButton {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
  <button id="refreshButton">Refresh Data</button>
  <div id="globeViz"></div>
  <div id="infoPanel">
    <h3 id="playerName">Player</h3>
    <p><b>Address:</b> <span id="address"></span></p>
    <p><b>Activity:</b> <span id="activity"></span></p>
    <p><b>Status:</b> <span id="status"></span></p>
    <p><b>Works With:</b></p>
    <ul id="worksWithList"></ul>
  </div>
  <script>
    const pointsSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaJd0h7-isjNPXFKJfzEMKJZ7bOPsqrfESDs7hj9skKws-SXMe0Z5alZXeJJHf8H18lkNwlAd6nwzL/pub?gid=0&single=true&output=csv';
    const partnersSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaJd0h7-isjNPXFKJfzEMKJZ7bOPsqrfESDs7hj9skKws-SXMe0Z5alZXeJJHf8H18lkNwlAd6nwzL/pub?gid=1922727520&single=true&output=csv';
    let globe;
    let points = []; // Store points globally for easy lookup

    function loadDataAndUpdateGlobe() {
      // Load points
      Papa.parse(pointsSheetUrl, {
        download: true,
        header: true,
        complete: function(pointsResults) {
          points = pointsResults.data.map(d => ({
            lat: parseFloat(d.lat),
            lng: parseFloat(d.lng),
            name: d.name,
            address: d.address,
            activity: d.activity,
            status: d.status
          }));

          // Load partners
          Papa.parse(partnersSheetUrl, {
            download: true,
            header: true,
            complete: function(partnersResults) {
              // Build partners object: { source: [target1, target2, ...] }
              const partners = {};
              partnersResults.data.forEach(row => {
                if (!partners[row.source]) partners[row.source] = [];
                partners[row.source].push(row.target);
              });

              // Build arcs between points
              const arcs = [];
              points.forEach(source => {
                (partners[source.name] || []).forEach(targetName => {
                  const target = points.find(p => p.name === targetName);
                  if (target) {
                    arcs.push({
                      startLat: source.lat,
                      startLng: source.lng,
                      endLat: target.lat,
                      endLng: target.lng,
                    });
                  }
                });
              });

              // Update or create the globe
              if (globe) {
                globe.pointsData(points)
                  .arcsData(arcs)
                  .labelsData(points);
              } else {
                globe = Globe()
                  .globeImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
                  .pointsData(points)
                  .pointLat('lat')
                  .pointLng('lng')
                  .pointLabel(d => `${d.name}\n\n• Address: ${d.address}\n• Activity: ${d.activity}\n• Status: ${d.status}`)
                  .pointColor(() => '#bbb')
                  .pointAltitude(0)
                  .pointRadius(0.2)
                  .arcsData(arcs)
                  .arcColor(() => '#ff7f0e') // Orange arcs
                  .arcStroke(0.2)
                  .arcDashLength(0) // No dash
                  .arcDashGap(0)   // No gap
                  .arcDashAnimateTime(0) // No animation
                  .labelsData(points)
                  .labelLat('lat')
                  .labelLng('lng')
                  .labelText('name')
                  .labelSize(0.3)
                  .labelDotRadius(0.2)
                  .labelColor(() => 'white')
                  (document.getElementById('globeViz'));

                // Info panel for more details
                globe.onPointClick(point => {
                  document.getElementById('playerName').innerText = point.name;
                  document.getElementById('address').innerText = point.address;
                  document.getElementById('activity').innerText = point.activity;
                  document.getElementById('status').innerText = point.status;
                  document.getElementById('worksWithList').innerHTML = '';
                  (partners[point.name] || []).forEach(name => {
                    const li = document.createElement('li');
                    // Find the partner's activity
                    const partnerPoint = points.find(p => p.name === name);
                    const partnerActivity = partnerPoint ? partnerPoint.activity : 'Unknown';
                    li.textContent = `${name} (${partnerActivity})`;
                    document.getElementById('worksWithList').appendChild(li);
                  });
                  document.getElementById('infoPanel').style.display = 'block';
                });
              }
            }
          });
        }
      });
    }

    document.getElementById('refreshButton').addEventListener('click', loadDataAndUpdateGlobe);
    loadDataAndUpdateGlobe(); // Load data on page load
  </script>
</body>
</html>
